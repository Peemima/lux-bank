<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firehawk Store User Management</title>
  <noscript>
    <h1>js_err_noscrpt_popup</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Tell Ian F about it immediately.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
<link rel="stylesheet" href="/lux-bank/assets/styles.css">
<!-- Custom styles for collapsible sections, or include them in styles.css -->
<style>
/* Basic styles for the collapsible sections */
.collapsible-section {
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden; /* To contain rounded corners properly */
}

.collapsible-label {
    background-color: #f0f0f0;
    padding: 10px 15px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    display: flex; /* For better alignment of text and count */
    justify-content: space-between; /* Puts count at the end */
    align-items: center;
    user-select: none; /* Prevent text selection on double click */
    transition: background-color 0.2s ease;
}

.collapsible-label:hover {
    background-color: #e0e0e0;
}

.collapsible-content {
    padding: 5px 0; /* Adjust padding as needed for user list */
    border-top: 1px solid #eee; /* Separator from label */
    background-color: #fff;
    /* Initial display state is controlled by JS */
}

/* Styles for search result messages */
#allUsers .user-info {
    padding: 15px;
    text-align: center;
    background-color: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-top: 10px;
}

/* Specific button styles for add user from search */
#allUsers .user-info .fill-button[onclick^="promptAndAddUser"] { /* Updated selector for new add user function */
    background-color: #4CAF50; /* Green for add */
    cursor: pointer !important;
}

#allUsers .user-info .fill-button[disabled] {
    background-color: #cccccc;
    cursor: not-allowed !important;
}

/* Ensure existing .user-top, .user-middle, .user-bottom styles still apply */
/* Adjust these if they were previously applying full border-radius */
.user-top, .user-middle, .user-bottom, .only-user {
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee; /* Add subtle separation */
}

.user-top { border-top-left-radius: 0; border-top-right-radius: 0; }
.user-bottom { border-bottom: none; } /* Last item doesn't need bottom border */
.only-user { border-bottom: none; border-radius: 0; }

/* New styles for user details form in modal */
.form-group {
    margin-bottom: 10px;
    display: flex; /* Arrange label and input in a row */
    align-items: center; /* Vertically align them */
}

.form-group label {
    flex: 0 0 80px; /* Fixed width for labels */
    margin-right: 10px;
    font-weight: bold;
    color: #333;
}

.form-group input.detail-input {
    flex-grow: 1; /* Input takes remaining space */
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1em;
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
}

/* Adjust button spacing */
#userDetailsForm .fill-button, #userDetailsForm .outline-button { /* Added outline-button for delete */
    margin-top: 15px;
    width: 100%; /* Make buttons full width */
}
#userDetailsForm .outline-button {
    background-color: #f44336; /* Red for delete */
    color: white;
    border: 1px solid #f44336;
}
#userDetailsForm .outline-button:hover {
    background-color: #d32f2f;
    border: 1px solid #d32f2f;
}

/* Jiggle animation for input errors */
.jiggle {
  animation: jiggle 0.5s;
  box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
}

@keyframes jiggle {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

</style>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    // Import `remove` method along with others for deleting users
    import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
        authDomain: "lux-bank.firebaseapp.com",
        databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
        projectId: "lux-bank",
        storageBucket: "lux-bank.appspot.com",
        messagingSenderId: "764922032293",
        appId: "1:764922032293:web:573599b6116f025ee15d4c",
        measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Removed window.businessValue as it's no longer needed

    let currentSearchQuery = "";
    // Global state to preserve collapse status for sections
    let collapsedStates = {};

    // Removed ensureBusinessAccountExists function as it's no longer needed

    // Helper: Capitalize first and last name
    function formatUserName(name) {
      return name
        .toLowerCase()
        .split(/\s+/) // Split on spaces
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
    }

    document.addEventListener("DOMContentLoaded", function() {
      // Removed ensureBusinessAccountExists() and fetchAndDisplayBusinessBalance() calls

      const searchForm = document.getElementById("searchForm");
      searchForm.addEventListener("submit", function(event) {
        event.preventDefault();
        currentSearchQuery = document.getElementById("searchInput").value.trim().toLowerCase();
        fetchAndDisplayUsers(currentSearchQuery);
        document.getElementById("resetButton").style.display = 'inline-block'; // Show reset button on search
      });

      const resetButton = document.getElementById("resetButton");
      resetButton.addEventListener("click", function() {
        document.getElementById("searchInput").value = "";
        currentSearchQuery = "";
        fetchAndDisplayUsers();
        this.style.display = 'none'; // Hide reset button
      });

      // Show reset button if there's a search query initially or on input
      document.getElementById("searchInput").addEventListener('input', function() {
        resetButton.style.display = this.value.trim() !== "" ? 'inline-block' : 'none';
      });
      // Initial state of reset button if page loads with a pre-filled search input
      if (document.getElementById("searchInput").value.trim() !== "") {
        resetButton.style.display = 'inline-block';
      }

      // Fetch and display users right away
      fetchAndDisplayUsers();
      // Removed fetchAndDisplayBusinessBalance() call
    });

    // Helper function to toggle section visibility
    function toggleSection(gradeLevel) {
      // Sanitize gradeLevel for use in HTML IDs (replace spaces with hyphens)
      const sectionId = `grade-${gradeLevel.replace(/\s/g, '-')}-content`;
      const sectionContent = document.getElementById(sectionId);
      if (sectionContent) {
        const isCurrentlyCollapsed = sectionContent.style.display === 'none';
        sectionContent.style.display = isCurrentlyCollapsed ? 'block' : 'none';
        collapsedStates[gradeLevel] = !isCurrentlyCollapsed; // Update the state
      }
    }

    function fetchAndDisplayUsers(query = "") {
      get(ref(database, 'users')).then((snapshot) => {
        const allUsersContainer = document.getElementById("allUsers");
        allUsersContainer.innerHTML = ''; // Clear existing content

        if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
          // Changed the button to directly add a new user without a specific search query
          allUsersContainer.innerHTML = `<div class="user-info"><p class="list-name">No users found.</p><button class="fill-button" onclick="promptAndAddUser('')">Add New User</button></div>`;
          return;
        }

        const usersData = snapshot.val();
        let filteredUsers = {};
        let foundMatchingUser = false;

        // Filter users based on query
        for (const key in usersData) {
          if (key.toLowerCase().includes(query)) {
            filteredUsers[key] = { key, ...usersData[key] }; // Add key to user object for easier access
            foundMatchingUser = true;
          }
        }

        if (!foundMatchingUser && query !== "") {
            // Changed the button to use the new promptAndAddUser function
            allUsersContainer.innerHTML = `
            <div class="user-info">
              <p class="list-name">No matching users found for "${query}".</p>
              <button class="fill-button" onclick="promptAndAddUser('${query}')">Add ${formatUserName(query)}</button>
            </div>`;
            return;
        }

        // Group filtered users by gradeLevel
        const usersByGrade = {};
        for (const key in filteredUsers) {
          const user = filteredUsers[key];
          // Ensure gradeLevel exists, provide a default if not (e.g., "Unknown")
          const gradeLevel = user.gradeLevel || "Unknown";
          if (!usersByGrade[gradeLevel]) {
            usersByGrade[gradeLevel] = [];
          }
          usersByGrade[gradeLevel].push(user);
        }

        const sortedGradeLevels = Object.keys(usersByGrade).sort((a, b) => {
            const getSortValue = (gradeStr) => {
                const cleanedGradeStr = gradeStr.trim().toLowerCase();

                // 1. "k" comes first
                if (cleanedGradeStr === "k") {
                    return -1; // Assign a value lower than any number
                }

                // 2. Numeric grades (1 through 12)
                let num;
                // Check for "Grade X" format
                const gradeMatch = cleanedGradeStr.match(/^grade (\d+)$/);
                if (gradeMatch) {
                    num = parseInt(gradeMatch[1], 10);
                } else {
                    // Check for direct numeric string "X"
                    num = parseInt(cleanedGradeStr, 10);
                }

                if (!isNaN(num) && num >= 1 && num <= 12) {
                    return num; // Use the number for sorting
                }

                // 3. All other strings (e.g., "Unknown", "High School", "Middle School", or anything else)
                return Infinity; // Assign a very high value to place them at the end
            };

            const valA = getSortValue(a);
            const valB = getSortValue(b);

            if (valA === valB && valA === Infinity) {
                // If both are "others" (Infinity), sort alphabetically
                return a.localeCompare(b);
            }
            // Otherwise, sort by their assigned numeric values
            return valA - valB;
        });


        // Render sections
        sortedGradeLevels.forEach(gradeLevel => {
          const usersInGrade = usersByGrade[gradeLevel];
          // Sanitize gradeLevel for use in HTML IDs
          const sectionIdSafe = `grade-${gradeLevel.replace(/\s/g, '-')}-content`;
          const labelIdSafe = `label-${gradeLevel.replace(/\s/g, '-')}`;

          let isInitiallyCollapsed;
          if (query !== "") { // If there's an active search query
              isInitiallyCollapsed = false; // Force expand all sections
          } else { // No search query, revert to stored state or default
              isInitiallyCollapsed = collapsedStates[gradeLevel] === undefined ? true : collapsedStates[gradeLevel];
          }

          let sectionHtml = `
            <div class="collapsible-section">
              <h3 class="collapsible-label" id="${labelIdSafe}">
                ${gradeLevel} <span style="font-size: 0.8em; color: #666;">(${usersInGrade.length} users)</span>
              </h3>
              <div id="${sectionIdSafe}" class="collapsible-content" style="display: ${isInitiallyCollapsed ? 'none' : 'block'};">
          `;

          usersInGrade.forEach((user, index) => {
            let positionClass = 'user-middle';
            if(usersInGrade.length === 1) {
              positionClass = 'only-user';
            } else if(index === 0){
              positionClass = 'user-top';
            } else if(index === usersInGrade.length - 1){
              positionClass = 'user-bottom';
            }
            sectionHtml += `<div class="${positionClass}"><p class="list-name">${user.key}: $${user.balance}</p><button class="fill-button" onclick="openModal('${user.key}')">Select</button></div>`;
          });

          sectionHtml += `
              </div>
            </div>
          `;
          allUsersContainer.innerHTML += sectionHtml;
        });

        // Attach event listeners after all elements are added to the DOM
        sortedGradeLevels.forEach(gradeLevel => {
          const labelIdSafe = `label-${gradeLevel.replace(/\s/g, '-')}`;
          const labelElement = document.getElementById(labelIdSafe);
          if (labelElement) {
            labelElement.addEventListener('click', () => toggleSection(gradeLevel));
          }
        });

      }).catch((error) => {
        console.error("Error fetching users: ", error);
        document.getElementById("allUsers").innerText = 'Err_fetching_users: A wild error apeared! Contact Ian F *immediately*';
      });
    }

    // NEW FUNCTION: Handles prompting for user details and adding a new user
    window.promptAndAddUser = async function(prefilledUserName = "") {
      let rawName = prefilledUserName || prompt("Enter new user's name:");
      if (!rawName) return; // User cancelled
  
      let userName = formatUserName(rawName); // ✅ Fix capitalization
  
      // Check if user name already exists
      const userExistsRef = ref(database, 'users/' + userName);
      const userExistsSnapshot = await get(userExistsRef);
      if (userExistsSnapshot.exists()) {
          alert(`User "${userName}" already exists. Please choose a different name or edit the existing user.`);
          return;
      }
  
      let balanceInput = prompt(`Enter starting balance for ${userName}: (e.g., 100.00)`);
      if (balanceInput === null) return;
      let balance = parseFloat(balanceInput);
      if (isNaN(balance) || balance < 0) {
          alert("Invalid balance. Please enter a non-negative number.");
          return;
      }
  
      let gradeLevel = prompt(`Enter grade level for ${userName}: (e.g., K, 1, 5, High School)`);
      if (gradeLevel === null) return;
      if (gradeLevel.trim() === '') gradeLevel = "Unknown";
  
      let weeklyPayroll = prompt(`Enter weekly payroll for ${userName}: (e.g., 5.00 or 10.50)`);
      if (weeklyPayroll === null) return;
  
      addUserWithUniqueID(userName, balance, gradeLevel, weeklyPayroll);
  };

    // Removed the old window.addUser function entirely.

    const generateUserID = () => {
        return Math.floor(1000 + Math.random() * 9000).toString(); // Generates a 4-digit number
    };

    const checkUserIDUnique = (userID) => {
        return get(ref(database, 'users')).then((snapshot) => {
            const users = snapshot.val();
            if (!users) return true; // No users, so ID is unique
            for (const userKey in users) { // Iterate through user keys
                if (users[userKey].id === userID) { // Check the 'id' property of each user
                    return false; // ID already exists
                }
            }
            return true; // ID is unique
        });
    };

    const createUser = (userID, userName, balance, gradeLevel, weeklyPayroll) => {
        const newUserRef = ref(database, 'users/' + userName);
        set(newUserRef, {
          id: userID,
          balance: balance,
          gradeLevel: gradeLevel,
          weeklyPayroll: weeklyPayroll
        }).then(() => {
          console.log('User added successfully.');
          fetchAndDisplayUsers(currentSearchQuery);
        }).catch((error) => {
          console.error('Error adding user:', error);
          alert('Error adding user: ' + error.message);
        });
    };

    const addUserWithUniqueID = async (userName, balance, gradeLevel, weeklyPayroll) => {
        let userID;
        let isUnique = false;

        while (!isUnique) {
          userID = generateUserID();
          isUnique = await checkUserIDUnique(userID);
        }

        createUser(userID, userName, balance, gradeLevel, weeklyPayroll);
    };

    // Removed window.addUserFromSearch as it's replaced by promptAndAddUser

    let selectedUserKey = ''; // To keep track of which user is selected
    let originalUserData = null; // Store the original fetched user data for comparison

    window.openModal = function(userKey) {
      selectedUserKey = userKey; // Set the selected user key
      document.getElementById('modal-header').innerText = `User Details: ${selectedUserKey}`; // Update modal title

      // Removed clearing previous input for transactions (amountInput)

      // Fetch user data and populate detail fields
      const userRef = ref(database, 'users/' + userKey);
      get(userRef).then((snapshot) => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          originalUserData = { ...userData }; // Store a copy of the original data

          document.getElementById('detailBalance').value = userData.balance !== undefined ? userData.balance : 0;
          document.getElementById('detailGrade').value = userData.gradeLevel !== undefined ? userData.gradeLevel : '';
          document.getElementById('detailPayroll').value = userData.weeklyPayroll !== undefined ? userData.weeklyPayroll : ''; // Assuming weeklyPayroll might be missing
          document.getElementById('detailUserId').value = userData.id !== undefined ? userData.id : '';

          document.getElementById('userModal').style.display = 'block'; // Show the modal
          // Removed setTimeout to focus on amountInput
        } else {
          console.error('No user found with the key:', userKey);
          alert('User data not found!');
          // Optionally, close modal or show an error state
          document.getElementById('userModal').style.display = 'none';
        }
      }).catch((error) => {
        console.error('Error fetching user data for modal:', error);
        alert('Error fetching user data!');
        document.getElementById('userModal').style.display = 'none';
      });
    };

    // Close the modal
    document.querySelector('.close').addEventListener('click', function() {
      document.getElementById('userModal').style.display = 'none';
    });

    // Removed addAmount, withdrawAmount, and amountInput event listener

    // New function to save user details
    window.saveUserDetails = function() {
        if (!selectedUserKey || !originalUserData) {
            console.error("No user selected or original data not loaded.");
            alert("Please select a user first.");
            return;
        }

        const updates = {};
        let changedFields = false;

        // Get current values from input fields
        const newBalance = parseFloat(document.getElementById('detailBalance').value);
        const newGrade = document.getElementById('detailGrade').value.trim();
        const newPayroll = document.getElementById('detailPayroll').value.trim();
        const newId = document.getElementById('detailUserId').value.trim();

        // Validate balance input
        if (isNaN(newBalance)) {
            alert("Balance must be a valid number.");
            document.getElementById('detailBalance').classList.add('jiggle');
            setTimeout(() => document.getElementById('detailBalance').classList.remove('jiggle'), 500);
            return;
        }
        // Basic validation for User ID (cannot be empty)
        if (!newId) {
            alert("User ID cannot be empty.");
            document.getElementById('detailUserId').classList.add('jiggle');
            setTimeout(() => document.getElementById('detailUserId').classList.remove('jiggle'), 500);
            return;
        }


        // Check if newId is unique if it changed
        if (newId !== originalUserData.id) {
            get(ref(database, 'users')).then((snapshot) => {
                const users = snapshot.val();
                let idExists = false;
                for (const key in users) {
                    if (key !== selectedUserKey && users[key].id === newId) { // Check against other users
                        idExists = true;
                        break;
                    }
                }
                if (idExists) {
                    alert("User ID already taken by another user. Please choose a unique ID.");
                    document.getElementById('detailUserId').classList.add('jiggle');
                    setTimeout(() => document.getElementById('detailUserId').classList.remove('jiggle'), 500);
                    return; // Stop the update process
                } else {
                    // Continue with the update after ID check
                    applyUpdates();
                }
            }).catch(error => {
                console.error("Error checking user ID uniqueness:", error);
                alert("Error checking user ID uniqueness.");
            });
        } else {
            // No change to ID, proceed with updates
            applyUpdates();
        }

        function applyUpdates() {
            // Compare and add to updates object
            // Use Number() for balance comparison to avoid issues with float precision or string comparison
            if (Number(newBalance.toFixed(2)) !== Number((parseFloat(originalUserData.balance) || 0).toFixed(2))) {
 // Compare fixed to 2 decimal places
                updates.balance = newBalance;
                changedFields = true;
            }
            if (newGrade !== (originalUserData.gradeLevel || '')) { // Compare with empty string if original is undefined/null
                updates.gradeLevel = newGrade;
                changedFields = true;
            }
            if (newPayroll !== (originalUserData.weeklyPayroll || '')) { // Compare with empty string if original is undefined/null
                updates.weeklyPayroll = newPayroll;
                changedFields = true;
            }
            if (newId !== originalUserData.id) { // Only update if ID changed and passed uniqueness check
                updates.id = newId;
                changedFields = true;
            }

            if (!changedFields) {
                alert("No changes detected.");
                return;
            }

            // Perform the update
            const userRef = ref(database, 'users/' + selectedUserKey);
            // Use `update` to merge changes, preserving other fields not explicitly updated
            update(userRef, updates).then(() => {
                console.log("User details updated successfully:", updates);
                alert("Details saved!");
                document.getElementById('userModal').style.display = 'none'; // Close modal on success
                fetchAndDisplayUsers(currentSearchQuery); // Refresh user list
            }).catch((error) => {
                console.error("Error updating user details:", error);
                alert("Error saving details: " + error.message);
            });
        }
    };

    // NEW FUNCTION: Delete User
    window.deleteUser = function() {
        if (!selectedUserKey) {
            alert("No user selected for deletion.");
            return;
        }

        if (confirm(`Are you sure you want to delete user "${selectedUserKey}"? This action cannot be undone.`)) {
            const userRef = ref(database, 'users/' + selectedUserKey);
            remove(userRef).then(() => {
                console.log(`User "${selectedUserKey}" deleted successfully.`);
                alert(`User "${selectedUserKey}" has been deleted.`);
                document.getElementById('userModal').style.display = 'none'; // Close modal
                fetchAndDisplayUsers(currentSearchQuery); // Refresh user list
                selectedUserKey = ''; // Clear selected user
                originalUserData = null; // Clear original data
            }).catch((error) => {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            });
        }
    };

    // Removed updateUserBalance, logTransaction, updateBusinessBalance functions

    // Removed setInterval for business balance. Only users refresh
    setInterval(() => {
      fetchAndDisplayUsers(currentSearchQuery); // Use the updated query for auto-refresh
    }, 5000); // Adjust the timing as necessary

    // fetchAndDisplayBusinessBalance() is no longer called or exists
  </script>
</head>
<body>
  <!-- Removed businessInfo div entirely -->

  <form id="searchForm">
    <input type="text" id="searchInput" placeholder="Search users...">
    <button class="fill-button" type="submit">Search</button>
    <button id="resetButton" style="display: none;" class="outline-button">Reset</button>
  </form>
  <div id="allUsers" class="container"></div>
  <!-- The Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 id="modal-header" style="font-family: 'poppins';">User Details</h2> <!-- Updated modal title -->

    <!-- Removed Transactions section entirely (h3, input, Add/Withdraw buttons) -->

    <div id="userDetailsForm">
      <div class="form-group">
        <label for="detailBalance">Balance</label>
        <input type="number" id="detailBalance" class="detail-input">
      </div>
      <div class="form-group">
        <label for="detailGrade">Grade</label>
        <input type="text" id="detailGrade" class="detail-input">
      </div>
      <div class="form-group">
        <label for="detailPayroll">Payroll</label>
        <input type="text" id="detailPayroll" class="detail-input">
      </div>
      <div class="form-group">
        <label for="detailUserId">User ID</label>
        <input type="text" id="detailUserId" class="detail-input">
      </div>
      <button class="fill-button" onclick="saveUserDetails()">Save Details</button>
      <button class="outline-button" onclick="deleteUser()">Delete User</button> <!-- Added Delete User button -->
    </div>
  </div>
</div>

</body>
</html>
