<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firehawk Store Point of Sale</title>
  <noscript>
    <h1>js_err_noscrpt_popup</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Tell Ian F about it immediately.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
<link rel="stylesheet" href="/lux-bank/assets/styles.css">
<!-- Custom styles for collapsible sections, or include them in styles.css -->
<style>
/* Basic styles for the collapsible sections */
.collapsible-section {
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden; /* To contain rounded corners properly */
}

.collapsible-label {
    background-color: #f0f0f0;
    padding: 10px 15px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    display: flex; /* For better alignment of text and count */
    justify-content: space-between; /* Puts count at the end */
    align-items: center;
    user-select: none; /* Prevent text selection on double click */
    transition: background-color 0.2s ease;
}

.collapsible-label:hover {
    background-color: #e0e0e0;
}

.collapsible-content {
    padding: 5px 0; /* Adjust padding as needed for user list */
    border-top: 1px solid #eee; /* Separator from label */
    background-color: #fff;
    /* Initial display state is controlled by JS */
}

/* Styles for search result messages */
#allUsers .user-info {
    padding: 15px;
    text-align: center;
    background-color: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    margin-top: 10px;
}

/* Specific button styles for add user from search */
#allUsers .user-info .fill-button[onclick^="addUserFromSearch"] {
    background-color: #4CAF50; /* Green for add */
    cursor: pointer !important;
}

#allUsers .user-info .fill-button[disabled] {
    background-color: #cccccc;
    cursor: not-allowed !important;
}

/* Ensure existing .user-top, .user-middle, .user-bottom styles still apply */
/* Adjust these if they were previously applying full border-radius */
.user-top, .user-middle, .user-bottom, .only-user {
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee; /* Add subtle separation */
}

.user-top { border-top-left-radius: 0; border-top-right-radius: 0; }
.user-bottom { border-bottom: none; } /* Last item doesn't need bottom border */
.only-user { border-bottom: none; border-radius: 0; }
</style>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
        authDomain: "lux-bank.firebaseapp.com",
        databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
        projectId: "lux-bank",
        storageBucket: "lux-bank.appspot.com",
        messagingSenderId: "764922032293",
        appId: "1:764922032293:web:573599b6116f025ee15d4c",
        measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.businessValue = "Firehawk Store";

    let currentSearchQuery = "";
    // Global state to preserve collapse status for sections
    // Default: { "Grade 3": true } means Grade 3 is collapsed.
    // If a grade level is not in this object, it defaults to collapsed on first render.
    let collapsedStates = {};

    // Function to check if business account exists and create it if not
    function ensureBusinessAccountExists() {
      if (businessValue != null) {
        const businessRef = ref(database, `businesses/${businessValue}`);
        get(businessRef).then((snapshot) => {
          if (!snapshot.exists()) {
            // Business doesn't exist, create it with initial balance of 0
            set(businessRef, { balance: 0 }).then(() => {
              console.log(`Business "${businessValue}" created with balance: 0`);
            }).catch((error) => {
              console.error('Error creating business:', error);
            });
          }
        }).catch((error) => {
          console.error('Error checking for business existence:', error);
        });
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      ensureBusinessAccountExists();

      const searchForm = document.getElementById("searchForm");
      searchForm.addEventListener("submit", function(event) {
        event.preventDefault();
        currentSearchQuery = document.getElementById("searchInput").value.trim().toLowerCase();
        fetchAndDisplayUsers(currentSearchQuery);
        document.getElementById("resetButton").style.display = 'inline-block'; // Show reset button on search
      });

      const resetButton = document.getElementById("resetButton");
      resetButton.addEventListener("click", function() {
        document.getElementById("searchInput").value = "";
        currentSearchQuery = "";
        fetchAndDisplayUsers();
        this.style.display = 'none'; // Hide reset button
      });

      // Show reset button if there's a search query initially or on input
      document.getElementById("searchInput").addEventListener('input', function() {
        resetButton.style.display = this.value.trim() !== "" ? 'inline-block' : 'none';
      });
      // Initial state of reset button if page loads with a pre-filled search input
      if (document.getElementById("searchInput").value.trim() !== "") {
        resetButton.style.display = 'inline-block';
      }

      // Fetch and display users right away
      fetchAndDisplayUsers();
      fetchAndDisplayBusinessBalance(); // Ensure business balance is also fetched initially
    });

    // Helper function to toggle section visibility
    function toggleSection(gradeLevel) {
      // Sanitize gradeLevel for use in HTML IDs (replace spaces with hyphens)
      const sectionId = `grade-${gradeLevel.replace(/\s/g, '-')}-content`;
      const sectionContent = document.getElementById(sectionId);
      if (sectionContent) {
        const isCurrentlyCollapsed = sectionContent.style.display === 'none';
        sectionContent.style.display = isCurrentlyCollapsed ? 'block' : 'none';
        collapsedStates[gradeLevel] = !isCurrentlyCollapsed; // Update the state
      }
    }

    function fetchAndDisplayUsers(query = "") {
      get(ref(database, 'users')).then((snapshot) => {
        const allUsersContainer = document.getElementById("allUsers");
        allUsersContainer.innerHTML = ''; // Clear existing content

        if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
          allUsersContainer.innerHTML = `<div class="user-info"><p class="list-name">No users found.</p><button style="cursor: not-allowed;" disabled class="fill-button">Search to Add Users</button></div>`;
          return;
        }

        const usersData = snapshot.val();
        let filteredUsers = {};
        let foundMatchingUser = false;

        // Filter users based on query
        for (const key in usersData) {
          if (key.toLowerCase().includes(query)) {
            filteredUsers[key] = { key, ...usersData[key] }; // Add key to user object for easier access
            foundMatchingUser = true;
          }
        }

        if (!foundMatchingUser && query !== "") {
            allUsersContainer.innerHTML = `<div class="user-info"><p class="list-name">No matching users found for "${query}".</p><button class="fill-button" onclick="addUserFromSearch('${query}')">Add ${query}</button></div>`;
            return;
        }

        // Group filtered users by gradeLevel
        const usersByGrade = {};
        for (const key in filteredUsers) {
          const user = filteredUsers[key];
          // Ensure gradeLevel exists, provide a default if not (e.g., "Unknown")
          const gradeLevel = user.gradeLevel || "Unknown";
          if (!usersByGrade[gradeLevel]) {
            usersByGrade[gradeLevel] = [];
          }
          usersByGrade[gradeLevel].push(user);
        }

        const sortedGradeLevels = Object.keys(usersByGrade).sort((a, b) => {
            const getSortValue = (gradeStr) => {
                const cleanedGradeStr = gradeStr.trim().toLowerCase();

                // 1. "k" comes first
                if (cleanedGradeStr === "k") {
                    return -1; // Assign a value lower than any number
                }

                // 2. Numeric grades (1 through 12)
                let num;
                // Check for "Grade X" format
                const gradeMatch = cleanedGradeStr.match(/^grade (\d+)$/);
                if (gradeMatch) {
                    num = parseInt(gradeMatch[1], 10);
                } else {
                    // Check for direct numeric string "X"
                    num = parseInt(cleanedGradeStr, 10);
                }

                if (!isNaN(num) && num >= 1 && num <= 12) {
                    return num; // Use the number for sorting
                }

                // 3. All other strings (e.g., "Unknown", "High School", "Middle School", or anything else)
                return Infinity; // Assign a very high value to place them at the end
            };

            const valA = getSortValue(a);
            const valB = getSortValue(b);

            if (valA === valB && valA === Infinity) {
                // If both are "others" (Infinity), sort alphabetically
                return a.localeCompare(b);
            }
            // Otherwise, sort by their assigned numeric values
            return valA - valB;
        });


        // Render sections
        sortedGradeLevels.forEach(gradeLevel => {
          const usersInGrade = usersByGrade[gradeLevel];
          // Sanitize gradeLevel for use in HTML IDs
          const sectionIdSafe = `grade-${gradeLevel.replace(/\s/g, '-')}-content`;
          const labelIdSafe = `label-${gradeLevel.replace(/\s/g, '-')}`;

          let isInitiallyCollapsed;
          if (query !== "") { // If there's an active search query
              isInitiallyCollapsed = false; // Force expand all sections
          } else { // No search query, revert to stored state or default
              isInitiallyCollapsed = collapsedStates[gradeLevel] === undefined ? true : collapsedStates[gradeLevel];
          }

          let sectionHtml = `
            <div class="collapsible-section">
              <h3 class="collapsible-label" id="${labelIdSafe}">
                ${gradeLevel} <span style="font-size: 0.8em; color: #666;">(${usersInGrade.length} users)</span>
              </h3>
              <div id="${sectionIdSafe}" class="collapsible-content" style="display: ${isInitiallyCollapsed ? 'none' : 'block'};">
          `;

          usersInGrade.forEach((user, index) => {
            let positionClass = 'user-middle';
            if(usersInGrade.length === 1) {
              positionClass = 'only-user';
            } else if(index === 0){
              positionClass = 'user-top';
            } else if(index === usersInGrade.length - 1){
              positionClass = 'user-bottom';
            }
            sectionHtml += `<div class="${positionClass}"><p class="list-name">${user.key}: $${user.balance}</p><button class="fill-button" onclick="openModal('${user.key}')">Select</button></div>`;
          });

          sectionHtml += `
              </div>
            </div>
          `;
          allUsersContainer.innerHTML += sectionHtml;
        });

        // Attach event listeners after all elements are added to the DOM
        sortedGradeLevels.forEach(gradeLevel => {
          const labelIdSafe = `label-${gradeLevel.replace(/\s/g, '-')}`;
          const labelElement = document.getElementById(labelIdSafe);
          if (labelElement) {
            labelElement.addEventListener('click', () => toggleSection(gradeLevel));
          }
        });

      }).catch((error) => {
        console.error("Error fetching users: ", error);
        document.getElementById("allUsers").innerText = 'Err_fetching_users: A wild error apeared! Contact Ian F *immediately*';
      });
    }

    // Modify addUser to include gradeLevel
    window.addUser = function(userName, startingBalance = 0, gradeLevel = "Unknown") { // Added gradeLevel parameter
      const generateUserID = () => {
        return Math.floor(1000 + Math.random() * 9000).toString();
      };

      const checkUserIDUnique = (userID) => {
        return get(ref(database, 'users/' + userID)).then((snapshot) => {
          return !snapshot.exists();
        });
      };

      const createUser = (userID, userName, gradeLevel) => { // Passed gradeLevel here
        const newUserRef = ref(database, 'users/' + userName);
        set(newUserRef, {
          id: userID,
          balance: startingBalance, // Use startingBalance
          gradeLevel: gradeLevel // Store gradeLevel
        }).then(() => {
          console.log('User added successfully.');
          fetchAndDisplayUsers(currentSearchQuery);
        }).catch((error) => {
          console.error('Error adding user:', error);
        });
      };

      const addUserWithUniqueID = async (userName, gradeLevel) => { // Passed gradeLevel here
        let userID;
        let isUnique = false;

        while (!isUnique) {
          userID = generateUserID();
          isUnique = await checkUserIDUnique(userID);
        }

        createUser(userID, userName, gradeLevel); // Passed gradeLevel here
      };

      addUserWithUniqueID(userName, gradeLevel);
    };

    // New function to handle adding user from search, providing a default grade
    window.addUserFromSearch = function(userName) {
        // Assign a random grade from "k" or "1" through "12" for new users added from search
        const gradesPool = ["k", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"];
        const randomGrade = gradesPool[Math.floor(Math.random() * gradesPool.length)];
        addUser(userName, 0, randomGrade);
    };


    let selectedUserKey = ''; // To keep track of which user is selected

    window.openModal = function(userKey) {
      selectedUserKey = userKey; // Set the selected user key
      document.getElementById('modal-header').innerText = selectedUserKey;
      document.getElementById('userModal').style.display = 'block'; // Show the modal
      // Clear previous input when opening modal
      document.getElementById('amountInput').value = '';
      setTimeout(() => {
        const input = document.getElementById('amountInput');
        if (input){
          input.focus();
        }
      }, 50); // 50ms is usually enough for modal to render
    };

    // Close the modal
    document.querySelector('.close').addEventListener('click', function() {
      document.getElementById('userModal').style.display = 'none';
    });

    // Make addAmount global
    window.addAmount = function() {
      const amountInput = document.getElementById('amountInput');
      const amount = Number(amountInput.value);
      if (isNaN(amount) || amount <= 0) {
        amountInput.classList.add('jiggle');
        setTimeout(() => amountInput.classList.remove('jiggle'), 500);
        return;
      }
      updateUserBalance(selectedUserKey, amount); // Positive amount for addition
    };

    // Jiggle when there's an input error: fix the weird character input problem
    document.getElementById('amountInput').addEventListener('input', function(e) {
      // Remove any non-digit characters from the input.
      const validValue = this.value.replace(/[^0-9]/g, '');

      // Check if the input value is not solely composed of digits.
      if (this.value !== validValue) {
        // Replace the input value with the cleaned, digit-only version.
        this.value = validValue;

        // Add the 'jiggle' class to trigger the animation.
        this.classList.add('jiggle');

        // Automatically remove the 'jiggle' class after the animation ends (500ms) to reset the state.
        setTimeout(() => {
          this.classList.remove('jiggle');
        }, 500);
      }
    });


    // Update user balance and log the transaction
    function updateUserBalance(userKey, amount) {
        const userRef = ref(database, 'users/' + userKey);

        // Fetch the current user data first to preserve all fields (e.g., gradeLevel)
        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                let currentBalance = userData.balance;
                let newBalance = currentBalance + amount; // Calculate the new balance

                // Update the user's balance in Firebase, preserving other data
                set(ref(database, 'users/' + userKey), {
                    ...userData, // Preserve existing user data (like gradeLevel, id)
                    balance: newBalance
                }).then(() => {
                    console.log('User balance updated successfully.');

                    if (amount < 0) { // If amount is negative, it's a withdrawal from user, so add to business
                        updateBusinessBalance(Math.abs(amount));
                    }

                    // Log the transaction, passing in the business name and current business balance
                    logTransaction(userKey, amount, newBalance, window.businessValue, window.businessData ? window.businessData.balance : 0);

                    document.getElementById('userModal').style.display = 'none'; // Close the modal
                    fetchAndDisplayUsers(currentSearchQuery); // Refresh user list after update
                    fetchAndDisplayBusinessBalance(); // Refresh business balance
                }).catch((error) => {
                    console.error('Error updating user balance:', error);
                });
            } else {
                console.log('No user found with the key:', userKey);
            }
        }).catch((error) => {
            console.error('Error fetching user data:', error);
        });
    }

    // Function to log transactions with unique IDs based on timestamp
    function logTransaction(userKey, amount, newBalance, businessValue, businessBalanceAmount) {
        const transactionID = `trans_${Date.now()}_${Math.floor(Math.random() * 1000)}`; // Generate a unique ID

        const transactionRef = ref(database, 'transactions/' + transactionID); // Use the generated ID

        const transactionData = {
            userKey: userKey,
            amount: amount,
            newBalance: newBalance,
            businessBalance: businessBalanceAmount,
            business: businessValue, // Business name is captured here
            timestamp: Date.now() // Capturing the timestamp
        };

        set(transactionRef, transactionData)
            .then(() => {
                console.log('Transaction logged successfully.');
            })
            .catch((error) => {
                console.error('Error logging transaction:', error);
            });
    }


    // Function to update the business's balance: Adds the amount to the current balance
    function updateBusinessBalance(amountToAdd) {
        const businessRef = ref(database, `businesses/${businessValue}/balance`);

        get(businessRef).then((snapshot) => {
            let newBalance;
            let currentBalance = snapshot.exists() ? snapshot.val() : 0; // Use current balance or default to 0

            // Addition of the given amount to the business balance
            newBalance = currentBalance + amountToAdd;

            // Update the balance in Firebase
            set(businessRef, newBalance).then(() => {
                console.log(`Business balance updated to ${newBalance}`);
                window.businessData = { balance: newBalance }; // Update global window.businessData
            }).catch((error) => {
                console.error('Error updating business balance:', error);
            });

        }).catch((error) => {
            console.error('Error fetching business balance:', error);
            // Initialize if fetching fails and no balance is found (Handling edge case)
            set(businessRef, amountToAdd).then(() => {
                console.log('Business balance initialized and set to:', amountToAdd);
                window.businessData = { balance: amountToAdd }; // Update global window.businessData
            }).catch((initError) => {
                console.error('Error initializing business balance:', initError);
            });
        });
    }

    window.withdrawAmount = function() {
        const amountInput = document.getElementById('amountInput');
        const amountToWithdraw = Number(amountInput.value);
        const userKey = selectedUserKey;

        if (isNaN(amountToWithdraw) || amountToWithdraw <= 0) {
          amountInput.classList.add('jiggle');
          setTimeout(() => amountInput.classList.remove('jiggle'), 500);
          return;
        }

        const userRef = ref(database, `users/${userKey}`);

        // Fetch the current user data first (to preserve all fields)
        get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                let currentBalance = userData.balance;
                if (amountToWithdraw > currentBalance) {
                    // Trigger jiggle animation if withdrawal amount exceeds the balance
                    amountInput.classList.add('jiggle');
                    setTimeout(() => {
                        amountInput.classList.remove('jiggle');
                    }, 500);
                } else {
                    let newBalance = currentBalance - amountToWithdraw; // Calculate the new balance after withdrawal

                    // Update the user's balance in Firebase, preserving other data
                    set(ref(database, 'users/' + userKey), {
                        ...userData, // Preserve existing user data (like gradeLevel, id)
                        balance: newBalance
                    }).then(() => {
                        console.log('Withdrawal successful, user balance updated.');

                        // This will add the withdrawn amount to the business balance
                        updateBusinessBalance(amountToWithdraw);

                        // Log the withdrawal transaction, note here the amount is negative
                        logTransaction(userKey, -amountToWithdraw, newBalance, window.businessValue, window.businessData ? window.businessData.balance : 0);

                        // Close the modal
                        document.getElementById('userModal').style.display = 'none';
                        fetchAndDisplayUsers(currentSearchQuery); // Refresh user list after update
                        fetchAndDisplayBusinessBalance(); // Refresh business balance
                    }).catch((error) => {
                        console.error('Error updating user balance:', error);
                    });
                }
            } else {
                console.log('User balance could not be found.');
            }
        }).catch((error) => {
            console.error('Error fetching user data:', error);
        });
    };


    function fetchAndDisplayBusinessBalance() {
      const businessRef = ref(database, `businesses/${businessValue}`);
      get(businessRef).then((snapshot) => {
        if (snapshot.exists()) {
          window.businessData = snapshot.val(); // Store business data globally
          document.getElementById('businessBalance').innerText = `Store earnings: $${businessData.balance}`;
        } else {
          console.error('Business data not found');
          document.getElementById('businessBalance').innerText = `Store earnings: $0`; // Display 0 if not found
          window.businessData = { balance: 0 }; // Initialize global businessData
        }
      }).catch((error) => {
        console.error('Error fetching business balance:', error);
        document.getElementById('businessBalance').innerText = 'Error fetching earnings';
        window.businessData = { balance: 0 }; // Default on error
      });
    }

    // Code to automatically update users and business balances
    setInterval(fetchAndDisplayBusinessBalance, 5000);

    setInterval(() => {
      fetchAndDisplayUsers(currentSearchQuery); // Use the updated query for auto-refresh
    }, 5000); // Adjust the timing as necessary

    // fetchAndDisplayBusinessBalance() is already called in DOMContentLoaded
  </script>
</head>
<body>
  <div id="businessInfo" style="display: grid; grid-template-columns: 1fr auto 1fr;">
  <span id="businessName" style="float: left;"><h1 style="font-family: Poppins;">Firehawk Store</h1></span>
    <img class="logo" src="/lux-bank/assets/fireyhills.png">
  <span id="businessBalance" style="float: right; text-align: right;">...</span>
</div>

  <form id="searchForm">
    <input type="text" id="searchInput" placeholder="Search users...">
    <button class="fill-button" type="submit">Search</button>
    <button id="resetButton" style="display: none;" class="outline-button">Reset</button>
  </form>
  <div id="allUsers" class="container"></div>
  <!-- The Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 id="modal-header" style="font-family: 'poppins';">Edit User Balance</h2>
    <p>Transactions are measured in Hawkeyes.</p>
    <!-- Form to add or withdraw -->
    <input type="text" id="amountInput" placeholder="Enter amount..." pattern="\d*">
    <button class="fill-button" onclick="addAmount()">Add</button>
    <button class="outline-button" onclick="withdrawAmount()">Withdraw</button>
  </div>
</div>

</body>
</html>
