<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>One More Step</title>
  <meta name="theme-color" content="#c0f0fb" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <noscript>
    <h1>js_err_noscrpt_popup</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Tell Ian F about it immediately.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
  <link rel="stylesheet" href="https://peemima.github.io/lux-bank/assets/styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
      authDomain: "lux-bank.firebaseapp.com",
      databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
      projectId: "lux-bank",
      storageBucket: "lux-bank.appspot.com",
      messagingSenderId: "764922032293",
      appId: "1:764922032293:web:573599b6116f025ee15d4c",
      measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const latestParentRef = ref(database, 'latestParentID');
    const usersRef = ref(database, 'users'); // Reference to the users node

    window.saveName = function() {
      const newName = document.querySelector('.bottomselect').value.trim(); // Get the entered name

      if (newName !== "" && window.latestParentID) { 
        const userRef = ref(database, `users/${window.userName}`); // Reference to the user using the ORIGINAL name

        // Update the user's key (name) in the database
        set(ref(database, `users/${newName}`), get(userRef).then((snapshot) => {
            return snapshot.val();
          })
        ).then(() => {
          // Remove the old user entry (with the original name)
          remove(userRef).then(()=> {
            window.redirectUrl = `${window.location.origin}/lux-bank/parent-card/?id=${window.latestParentID}`;
            // window.location.href = window.redirectUrl;
          })
        }).catch((error) => {
          console.error("Error updating user name:", error);
          alert("There was a problem updating your name."); // Show an error message to the user
        });
      } else {
          window.redirectUrl = `${window.location.origin}/lux-bank/parent-card/?id=${window.latestParentID}`;
          window.location.href = window.redirectUrl;
      }
    };

    get(latestParentRef).then((snapshot) => {
      if (snapshot.exists()) {
        window.latestParentID = snapshot.val().id;

        if (latestParentID !== "0" && latestParentID !== "1") {
          // Get the user data based on latestParentID
          get(usersRef).then((usersSnapshot) => {
            if (usersSnapshot.exists()) {
              let userName = ""; // Initialize userName

              usersSnapshot.forEach((userSnapshot) => {
                const user = userSnapshot.val();
                if (user.id === latestParentID) {
                  userName = userSnapshot.key; // Get the user's name (the key)
                  return true; // Stop iterating once the user is found
                }
              });

              // Set the input field value *after* getting the user name
              document.querySelector('.bottomselect').value = userName;
              window.userName = userName;


              set(latestParentRef, { id: "0" })
                .then(() => {
                  const baseUrl = window.location.origin;
                  window.redirectUrl = `${baseUrl}/lux-bank/parent-card/?id=${latestParentID}`;
                  window.location.href = redirectUrl;
                })
                .catch((error) => {
                  console.error("Error resetting latest parent ID:", error);
                });
            } else {
              console.log("No users found.");
            }
          }).catch((error) => {
            console.error("Error fetching users:", error);
          });

        } else {
          console.log("Latest parent ID is either 0 or 1. No redirection.");
        }
      } else {
        console.log("No latest parent ID found.");
      }
    }).catch((error) => {
      console.error("Error fetching latest parent ID:", error);
    });

  </script>
  <style>
    html {
        height: 100%;
    }
    body {
        background-color: #c0f0fb;
        color: black;
        padding: 20px;
        height: 100%;
    }
    @keyframes magic-gradient {
        0% {
            background-position: 100% 100%; /* Start from the end */
            background-size: 10000% 10000%;
            transform: scale(1.02);
        }
        20% {
            background-position: 100% 100%; /* Stay at the end initially*/
        }
        90% {
            background-position: 0% 0%; /* Move to the start */
            background-size: 700% 700%;
        }
        100% {
            background-position: 0% 0%; /* Move to the start */
            background-size: 10000% 10000%;
        }
    }
    @keyframes fade-in {
        0% {
            opacity: 0%;
        }
        100% {
            opacity: 100%;
        }
    }
    h1 {
        display: inline-block;
        animation: magic-gradient 2s ease-in-out;
        animation-fill-mode: forwards;
        /* Flipped gradient */
        background: linear-gradient(130deg, rgba(82,113,255,1) 0%, rgba(158,69,255,1) 25%, rgba(56,182,255,1) 51%, rgba(192,240,251,1) 100%); 
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        background-position: 0% 0%; /* Initial position adjusted */
        background-size: 600% 600%;
        font-size: 50px;
        font-family: 'Poppins', sans-serif; /* Corrected typo in font-family */
    }
    p {
        font-size: 20px;
        margin-bottom: 20px;
    }
    button {
      color: black !important;
      border: none !important;
      background-color: white !important;
    }
    .bottomselect {
        height: 48px;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8.5px);
        -webkit-backdrop-filter: blur(8.5px);
        background-color: rgba(255, 255, 255, 1);
        border: 2px solid rgba(255, 255, 255, 0.17);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        display: block;
        outline: none;
    }
    .fade {
        opacity: 0%;
        animation: fade-in 1.5s ease-in-out;
        animation-delay: 1.5s;
        animation-fill-mode: forwards;
    }
    .bottom {
        position: absolute;
        display: flex;
        align-items: center;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px; /* Add padding as needed */
        box-sizing: border-box; /* Ensure padding doesn't add to width */
    }
    .bottom .bottomselect {
        flex-grow: 1; /* Allow input to expand and fill available space */
        margin-right: 10px; /* Add some space between input and button */
        font-size: 16px;
    }
    .bottom button { /* Style the button */
        height: 48px; /* Match input height */
        border-radius: 20px; /* Match input border radius */
    }
  </style>
</head>
<body>
  <h1>We're glad<br> you're here.</h1>
  <br>
  <div class="fade">
      <p>Let's get you ready to shop.<br>First, double check your name spelling.<br></p>
      <div class="bottom">
        <input class="bottomselect" placeholder="Full Name"><button class="outline-button">Save
      </div>
    </div>
</body>
</html>
