<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Day Business Dashboard</title>
  <script src="https://peemima.github.io/lux-bank/assets/popup-code.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://peemima.github.io/lux-bank/assets/loading-screen.js"></script>
  <noscript>
    <h1>Help is on the way, Javascript is not enabled.</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Help is on the way.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
  <link rel="stylesheet" href="/lux-bank/assets/styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
        authDomain: "lux-bank.firebaseapp.com",
        databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
        projectId: "lux-bank",
        storageBucket: "lux-bank.appspot.com",
        messagingSenderId: "764922032293",
        appId: "1:764922032293:web:573599b6116f025ee15d4c",
        measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    console.log("%cVersion: %c2.11", "color: black; font-size:75px;", "color: red; font-size:75px;");

    window.hideElement = function(identifier) {
      document.querySelectorAll(identifier).forEach(item => { item.style.display= 'none'; });
    };

    window.showElement = function(identifier) {
      document.querySelectorAll(identifier).forEach(item => { item.attributeStyleMap.delete('display') });
    };

    window.err = function(mode) {
      window.fatelError = mode;
    }

    window.rld = function() {
      window.location.reload(true);
    }
    
    window.businessValue = new URLSearchParams(window.location.search).get('businessvalue');
    window.balanceName = "Balance";

    // Global state for products and quantities
    window.currentProducts = {}; 
    window.selectedQuantities = {}; 
    window.totalSaleAmount = 0;
    window.editingMode = false; // NEW: Track editing mode

    if (businessValue) {
      document.getElementById("businessName").innerText = businessValue;

      if (businessValue == "Firehawk Store") {
        balanceName = "Total Earned";
        document.getElementById("homepage-heading").innerText = "Hello, Firehawk Banker";
        document.getElementById("transaction-option").innerText = "New Sale";
        document.getElementById("auction-option").style.display = "none";
      }

      function ensureBusinessAccountExists() {
        if (businessValue != null) {
          const businessRef = ref(database, `businesses/${businessValue}`);
          get(businessRef).then((snapshot) => {
            if (!snapshot.exists()) {
              window.location.href = `?businessvalue=`;
            }
          }).catch((error) => {
            console.error('Error checking for business existence:', error);
          });
        }
      }

      window.fatelError = false;

      document.addEventListener("DOMContentLoaded", function() {
        ensureBusinessAccountExists();
        fetchAndDisplayBusinessBalance();
        updateBusinessTimestamp();
        setInterval(function () {
          updateBusinessTimestamp();
        }, 20000);
      });

      // Updated: Process Sale is now handled by a button click, not form submit
      document.getElementById("processSaleButton").addEventListener("click", function(event) {
        event.preventDefault(); 

        const userID = window.latestUserID;
        const amount = window.totalSaleAmount;

        if (isNaN(amount) || amount <= 0) {
          showPopup("flex", "Notice", "block", "Please select products to make a sale.");
          return;
        }
        if (isNaN(userID) || userID === '0') {
          console.error("The user ID scanned is not a valid number or not scanned yet");
          showPopup("flex", "Help is on the way", "none", "Please scan a shopper's card first.");
          window.err(true);
          return;
        }

        processTransaction(userID, amount);
        window.latestUserID = '0';
      });

      function processTransaction(userID, amount) {
        get(ref(database, 'users')).then((snapshot) => {
          if (snapshot.exists()) {
            const users = snapshot.val();
            let userFound = false;
            for (let userKey in users) {
              if (users[userKey].id === userID) {
                userFound = true;
                let currentBalance = users[userKey].balance;
                if (amount > currentBalance) {
                  showPopup("flex", "Not enough hawkeyes", "block", `It looks like there aren't enough hawkeyes to buy that.`);
                  return;
                }

                let newBalance = currentBalance - amount; 
                set(ref(database, 'users/' + userKey + '/balance'), newBalance)
                  .then(() => {
                    updateBusinessBalance(amount);
                    logTransaction(userKey, userID, -amount, newBalance, businessValue, window.businessData.balance); 
                    iframeControl('start');
                    hideElement('#transaction-details-area');
                    showElement('#homepage-heading');
                    showPopup("flex", "Success!", "block", `The transaction was successful!`);
                    window.clearProductSelection();
                    hideElement('#transaction-screen'); // Hide the transaction display
                  })
                  .catch((error) => {
                    console.error('Error updating user balance:', error);
                    showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
                    window.err(true);
                  });
                return; 
              }
            }
            if (!userFound) {
              showPopup("flex", "Notice", "block", "That doesn't seem to be a valid user id.");
            }
          } else {
            console.log('No users found in the database.');
            showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
            window.err(true);
          }
        }).catch((error) => {
          console.error('Error fetching user data:', error);
          showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
          window.err(true);
        });
      }

      function logTransaction(userKey, userId, amount, newBalance, businessValue, businessBalanceAmount) {
        const transactionID = `trans_${Date.now()}_${Math.floor(Math.random() * 1000)}`; 
        const transactionRef = ref(database, 'transactions/' + transactionID); 
        const transactionData = {
          userKey: userKey,
          userId: userId,
          amount: amount,
          newBalance: newBalance,
          businessBalance: businessBalanceAmount,
          business: businessValue, 
          timestamp: Date.now(),
          productsSold: window.selectedQuantities 
        };

        set(transactionRef, transactionData)
          .then(() => {
            console.log('Transaction logged successfully.');
          })
          .catch((error) => {
            console.error('Error logging transaction:', error);
            showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
            window.err(true);
          });
      }

      function updateBusinessBalance(amountToAdd) {
        const businessRef = ref(database, `businesses/${businessValue}/balance`);
        get(businessRef).then((snapshot) => {
          let newBalance;
          let currentBalance = snapshot.exists() ? snapshot.val() : 0; 
          newBalance = currentBalance + amountToAdd;
          set(businessRef, newBalance).then(() => {
            console.log(`Business balance updated to ${newBalance}`);
            fetchAndDisplayBusinessBalance(); 
          }).catch((error) => {
            console.error('Error updating business balance:', error);
            showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
            window.err(true);
          });
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
          set(businessRef, amountToAdd).then(() => {
            console.log('Business balance initialized and set to:', amountToAdd);
          }).catch((initError) => {
            console.error('Error initializing business balance:', initError);
            showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
            window.err(true);
          });
        });
      }

      function fetchAndDisplayBusinessBalance() {
        const businessRef = ref(database, `businesses/${businessValue}`);
        get(businessRef).then((snapshot) => {
          if (snapshot.exists()) {
            window.businessData = snapshot.val();
            document.getElementById('businessBalance').innerText = balanceName + `: $${window.businessData.balance}`;
          } else {
            console.error('Business data not found');
            window.businessData = { balance: 0 };
            document.getElementById('businessBalance').innerText = balanceName + `: $0`;
          }
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
          showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
          window.err(true);
        });
      }

      function updateBusinessTimestamp() {
        if (window.fatelError === false) {
          const businessRef = ref(database, `businesses/${businessValue}/timestamp`);
          get(businessRef).then((snapshot) => {
            if (snapshot.exists()) {
              const timestamp = snapshot.val();
              if (timestamp === 1) {
                showPopup("flex", "We're glad you're here", "none", "Bring this device to Ian F to get started.");
              } else {
                const businessRef = ref(database, `businesses/${businessValue}/timestamp`);
                set(businessRef, Date.now()).then(() => {
                  console.log('Business timestamp updated successfully.');
                }).catch((error) => {
                  console.error('Error updating business timestamp:', error);
                });
              }
            } else {
              set(businessRef, Date.now()).then(() => {
                console.log('Business timestamp initialized.');
              }).catch((error) => {
                console.error('Error initializing business timestamp:', error);
              });
            }
          }).catch((error) => {
            console.error('Error fetching business timestamp:', error);
          });
        }
        if (window.fatelError === true) {
          const businessRef = ref(database, `businesses/${businessValue}/timestamp`);
          set(businessRef, 0).then(() => {
            console.log('Business timestamp updated successfully.');
          }).catch((error) => {
            console.error('Error updating business timestamp:', error);
          });
        }
      }

      setInterval(fetchAndDisplayBusinessBalance, 120000);

      // --- Product/Sale/Editing Logic ---

      window.fetchAndRenderProducts = async function() {
        const productsRef = ref(database, `businesses/${businessValue}/products`);
        try {
          const snapshot = await get(productsRef);
          window.currentProducts = {};
          if (snapshot.exists()) {
            const productsData = snapshot.val();
            for (const productName in productsData) {
              window.currentProducts[productName] = {
                price: parseFloat(productsData[productName])
              };
              if (window.selectedQuantities[productName] === undefined) {
                window.selectedQuantities[productName] = 0;
              }
            }
          }
          window.renderProductsGrid();
        } catch (error) {
          console.error('Error fetching products:', error);
          showPopup("flex", "Help is on the way", "none", "Error fetching product data.");
          window.err(true);
        }
      };

      window.renderProductsGrid = function() {
        const productsGrid = document.getElementById('products-grid');
        productsGrid.innerHTML = '';

        if (Object.keys(window.currentProducts).length === 0 && !window.editingMode) {
          productsGrid.innerHTML = '<p style="text-align: center; color: #666;">No products found.</p>';
        } else if (Object.keys(window.currentProducts).length === 0 && window.editingMode) {
            productsGrid.innerHTML = '<p style="text-align: center; color: #666;">No products found. Add some using the "Add New Product" form below.</p>';
        }

        for (const productName in window.currentProducts) {
          const product = window.currentProducts[productName];
          const selectedQty = window.selectedQuantities[productName] || 0;
          const safeProductNameId = productName.replace(/[^a-zA-Z0-9]/g, '-');

          const productCard = document.createElement('div');
          productCard.classList.add('product-card');
          // Store original name and price as data attributes for editing mode
          productCard.setAttribute('data-original-name', productName);
          productCard.setAttribute('data-original-price', product.price);

          let cardContent = '';
          if (window.editingMode) {
            // Editing mode: inputs for name and price, delete button
            cardContent = `
                <h3>
                    <input type="text" id="edit-name-${safeProductNameId}" value="${productName}" class="edit-input-name" data-original-name="${productName}" required>
                </h3>
                <p class="price-edit-group">
                    <label for="edit-price-${safeProductNameId}" class="price-label">Price: $</label>
                    <input type="number" id="edit-price-${safeProductNameId}" value="${product.price}" step="1" min="1" class="edit-input-price" required>
                </p>
                <button type="button" class="delete-product-button outline-button" onclick="window.deleteProduct('${productName}')">Delete</button>
            `;
          } else {
            // Default (sale) mode: display name/price, quantity controls
            cardContent = `
                <h3>${productName}</h3>
                <p>Price: $${product.price}</p>
                <div class="quantity-control">
                  <button type="button" onclick="window.adjustProductQuantity('${productName}', -1)">-</button>
                  <span id="qty-${safeProductNameId}" class="product-quantity">${selectedQty}</span>
                  <button type="button" onclick="window.adjustProductQuantity('${productName}', 1)">+</button>
                </div>
            `;
          }
          productCard.innerHTML = cardContent;
          productsGrid.appendChild(productCard);
        }
        window.calculateTotalSale();
        window.updateTransactionAreaButtons(); // NEW: Update buttons based on mode
      };

      window.adjustProductQuantity = function(productName, delta) {
        if (window.editingMode) return; // Prevent quantity adjustment in editing mode

        let currentQty = window.selectedQuantities[productName] || 0;
        let newQty = currentQty + delta;

        if (newQty < 0) {
          newQty = 0;
        }

        window.selectedQuantities[productName] = newQty;

        const safeProductNameId = productName.replace(/[^a-zA-Z0-9]/g, '-');
        const qtySpan = document.getElementById(`qty-${safeProductNameId}`);
        if (qtySpan) {
          qtySpan.innerText = newQty;
        }
        window.calculateTotalSale();
      };

      window.calculateTotalSale = function() {
        // Only calculate total if not in editing mode
        if (window.editingMode) {
            window.totalSaleAmount = 0;
            if (document.getElementById('totalSaleAmount')) {
                document.getElementById('totalSaleAmount').innerText = `$0.00`;
            }
            return;
        }

        let total = 0;
        for (const productName in window.selectedQuantities) {
          const qty = window.selectedQuantities[productName];
          const product = window.currentProducts[productName];
          if (qty > 0 && product) {
            total += qty * product.price;
          }
        }
        window.totalSaleAmount = total;
        if (document.getElementById('totalSaleAmount')) {
            document.getElementById('totalSaleAmount').innerText = `$${total.toFixed(2)}`;
        }
      };

      window.clearProductSelection = function() {
        if (window.editingMode) return; // Prevent clearing selection in editing mode

        for (const productName in window.selectedQuantities) {
          window.selectedQuantities[productName] = 0;
        }
        window.renderProductsGrid();
      };

      window.showAddProductForm = function(show) {
        const addProductFormContainer = document.getElementById('add-product-form-container');
        if (show) {
          addProductFormContainer.style.display = 'block';
          document.getElementById('newProductName').value = '';
          document.getElementById('newProductPrice').value = '';
          document.getElementById('newProductName').focus();
        } else {
          addProductFormContainer.style.display = 'none';
        }
      };

      window.addNewProduct = async function() {
        // Validation for the Add New Product form itself
        const newProductNameInput = document.getElementById('newProductName');
        const newProductPriceInput = document.getElementById('newProductPrice');

        if (!newProductNameInput.reportValidity() || !newProductPriceInput.reportValidity()) {
            // The browser's native validation will show messages if fields are invalid
            return;
        }
        
        const newProductName = newProductNameInput.value.trim();
        const newProductPrice = parseFloat(newProductPriceInput.value);

        // Client-side check for existing name
        if (window.currentProducts[newProductName]) {
            showPopup("flex", "Notice", "block", `A product named "${newProductName}" already exists.`);
            return;
        }

        try {
          const productRef = ref(database, `businesses/${businessValue}/products/${newProductName}`);
          await set(productRef, newProductPrice);
          showPopup("flex", "Success!", "block", `${newProductName} added successfully.`);
          window.showAddProductForm(false);
          window.fetchAndRenderProducts(); // Refresh product list in editing mode
        } catch (error) {
          console.error('Error adding new product:', error);
          showPopup("flex", "Help is on the way", "none", "Error adding product.");
          window.err(true);
        }
      };

      window.deleteProduct = async function(productName) {
        if (!window.editingMode) return; // Only allow deletion in editing mode

        if (!confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone.`)) {
          return;
        }

        try {
          const productRef = ref(database, `businesses/${businessValue}/products/${productName}`);
          await remove(productRef);
          showPopup("flex", "Success!", "block", `${productName} deleted successfully.`);
          
          delete window.currentProducts[productName];
          delete window.selectedQuantities[productName]; // Also remove from selected quantities

          window.renderProductsGrid(); // Re-render to reflect deletion
        } catch (error) {
          console.error('Error deleting product:', error);
          showPopup("flex", "Help is on the way", "none", "Error deleting product.");
          window.err(true);
        }
      };

      // NEW: Toggle Editing Mode
      window.toggleEditingMode = function() {
        window.editingMode = !window.editingMode;
        // Reset selected quantities when entering/exiting editing mode
        window.clearProductSelection(); 
        window.fetchAndRenderProducts(); // Re-render everything to apply mode changes
      };

      // NEW: Update visibility and text of buttons in transaction area
      window.updateTransactionAreaButtons = function() {
          const processSaleButton = document.getElementById('processSaleButton');
          const cancelButton = document.getElementById('cancel-button'); // "Back" button
          const productSummaryDiv = document.getElementById('product-summary'); // Changed to div for product-summary
          const addProductToggleButton = document.getElementById('add-product-toggle-button');
          const toggleEditModeButton = document.getElementById('toggleEditModeButton');
          
          const actionButtonsContainer = document.querySelector('#transaction-screen .action-buttons-container');

          // Ensure dynamic buttons exist or create them
          let saveAllEditsButton = document.getElementById('saveAllEditsButton');
          let cancelAllEditsButton = document.getElementById('cancelAllEditsButton');

          if (!saveAllEditsButton) {
              saveAllEditsButton = document.createElement('button');
              saveAllEditsButton.id = 'saveAllEditsButton';
              saveAllEditsButton.type = 'button';
              saveAllEditsButton.classList.add('fill-button');
              saveAllEditsButton.innerText = 'Save All Changes';
              saveAllEditsButton.addEventListener('click', window.saveAllProductEdits);
              actionButtonsContainer.appendChild(saveAllEditsButton);
          }

          if (!cancelAllEditsButton) {
              cancelAllEditsButton = document.createElement('button');
              cancelAllEditsButton.id = 'cancelAllEditsButton';
              cancelAllEditsButton.type = 'button';
              cancelAllEditsButton.classList.add('outline-button');
              cancelAllEditsButton.innerText = 'Cancel Edits';
              cancelAllEditsButton.addEventListener('click', window.cancelAllProductEdits);
              actionButtonsContainer.appendChild(cancelAllEditsButton);
          }


          if (window.editingMode) {
              // Editing Mode
              processSaleButton.style.display = 'none';
              cancelButton.style.display = 'none'; // "Back" button for scanner
              productSummaryDiv.style.display = 'none'; // Hide total and clear selection div
              addProductToggleButton.style.display = 'block'; // Show add product form button
              toggleEditModeButton.innerText = 'Done Editing';
              
              saveAllEditsButton.style.display = 'inline-block';
              cancelAllEditsButton.style.display = 'inline-block';

          } else {
              // Default (Sale) Mode
              processSaleButton.style.display = 'inline-block';
              cancelButton.style.display = 'inline-block'; // "Back" button
              productSummaryDiv.style.display = 'block'; // Show total and clear selection div
              addProductToggleButton.style.display = 'none'; // Hide add product form button
              toggleEditModeButton.innerText = 'Edit Products';
              window.showAddProductForm(false); // Ensure add product form is hidden

              saveAllEditsButton.style.display = 'none';
              cancelAllEditsButton.style.display = 'none';
          }
      };

      // NEW: Save all edited products
      window.saveAllProductEdits = async function() {
        if (!confirm('Are you sure you want to save all changes?')) {
            return;
        }

        const updates = []; // Array to store {originalName, newName, newPrice} for processing
        const newProductNames = new Set(); // To check for duplicate names within the current batch of edits
        const originalProductNamesInDb = new Set(Object.keys(window.currentProducts)); // Snapshot of names from DB for conflict checking

        // First pass: Validate inputs and collect all proposed changes
        const productCards = document.querySelectorAll('#products-grid .product-card');
        for (const card of productCards) {
            const originalName = card.getAttribute('data-original-name');
            const originalPrice = parseFloat(card.getAttribute('data-original-price'));
            
            const safeProductNameId = originalName.replace(/[^a-zA-Z0-9]/g, '-');
            const nameInput = document.getElementById(`edit-name-${safeProductNameId}`);
            const priceInput = document.getElementById(`edit-price-${safeProductNameId}`);

            // Perform native HTML5 validation
            if (!nameInput.reportValidity() || !priceInput.reportValidity()) {
                showPopup("flex", "Validation Error", "block", `Please correct the inputs for product "${originalName}".`);
                return; // Stop processing if any validation fails
            }

            const newName = nameInput.value.trim();
            const newPrice = parseFloat(priceInput.value);

            // Check for duplicate names among current *edited* products in this batch
            // This ensures if user types "A" and "B" into two inputs, they are unique within this edit session
            if (newProductNames.has(newName) && newName !== originalName) {
                showPopup("flex", "Validation Error", "block", `Duplicate product name "${newName}". All product names must be unique within this edit session.`);
                return;
            }
            newProductNames.add(newName);

            updates.push({ originalName, newName, newPrice, originalPrice });
        }

        // Second pass: Execute Firebase operations sequentially
        try {
            for (const update of updates) {
                const { originalName, newName, newPrice, originalPrice } = update;

                if (newName !== originalName) {
                    // Scenario 1: Product name has changed (rename)
                    // Check if the NEW name exists as an ORIGINAL product name in DB that is *not* being renamed itself in this batch.
                    // This prevents overwriting an existing product if 'newName' was already a product not part of this edit batch.
                    if (originalProductNamesInDb.has(newName) && !updates.some(u => u.originalName === newName)) {
                        showPopup("flex", "Validation Error", "block", `Cannot rename "${originalName}" to "${newName}" because a product with that exact name already exists.`);
                        return; // Stop if there's a conflict
                    }
                    await remove(ref(database, `businesses/${businessValue}/products/${originalName}`));
                    await set(ref(database, `businesses/${businessValue}/products/${newName}`), newPrice);
                    console.log(`Renamed "${originalName}" to "${newName}" with price $${newPrice}`);
                } else if (newPrice !== originalPrice) {
                    // Scenario 2: Only price has changed
                    await set(ref(database, `businesses/${businessValue}/products/${originalName}`), newPrice);
                    console.log(`Updated price of "${originalName}" to $${newPrice}`);
                }
                // Scenario 3: Both name and price are unchanged (do nothing)
            }
            showPopup("flex", "Success!", "block", "All product changes saved successfully.");
            window.editingMode = false; // Exit editing mode
            window.fetchAndRenderProducts(); // Re-fetch and re-render the updated list
        } catch (error) {
            console.error('Error saving product changes:', error);
            showPopup("flex", "Help is on the way", "none", "Error saving product changes: " + error.message);
            window.err(true);
        }
      };

      // NEW: Cancel all product edits
      window.cancelAllProductEdits = function() {
        if (!confirm('Are you sure you want to discard all unsaved changes?')) {
            return;
        }
        window.editingMode = false; // Exit editing mode
        window.fetchAndRenderProducts(); // Re-fetch and re-render the original list (discards input values)
        showPopup("flex", "Canceled", "block", "All unsaved changes have been discarded.");
      };

    } else {
      document.getElementById("main-content").style.display = 'none'; 
      document.getElementById("login-screen").style.display = 'block'; 

      let businessSuggestions = [];

      document.getElementById("businessNameInput").addEventListener("mousedown", function() {
        document.getElementById("businessNameInput").placeholder = "Business Name";
      });

      document.getElementById("businessNameInput").addEventListener("blur", function() {
        document.getElementById("businessNameInput").placeholder = "";
      });

      document.getElementById("businessNameInput").addEventListener("input", function() {
        const inputValue = this.value.trim().toLowerCase();
        get(ref(database, 'businesses')).then(snapshot => {
          if (snapshot.exists()) {
            const businesses = snapshot.val();
            businessSuggestions = Object.keys(businesses).filter(business => 
              business.toLowerCase().includes(inputValue)
            );

            if (businessSuggestions.length === 1) { 
              updateSuggestions(businessSuggestions[0]);
            } else {
              document.getElementById('suggestions').style.display = 'none'; 
            }
          } else {
            console.error('No businesses found in the database.');
          }
        }).catch(error => {
          console.error('Error fetching businesses:', error);
        });
      });

      function updateSuggestions(suggestion) {
        const suggestionList = document.getElementById('suggestions');
        if (suggestion) {
          suggestionList.style.display = 'block'; 
          suggestionList.innerText = 'Press Enter to login to ' + suggestion;
        } else {
          suggestionList.innerText = 'No businesses found';
        }
      }

      document.getElementById("businessNameInput").addEventListener("keydown", (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const suggestionText = document.getElementById('suggestions').innerText;
          const match = suggestionText.match(/Press Enter to login to (.+)/);
          if (match && match[1]) {
            const suggestion = match[1];
            window.location.href = `?businessvalue=${suggestion}`;
          } else {
            showPopup("flex", "Login Error", "block", "Please enter a valid business name or select from suggestions.");
          }
        }
      });
    };

    document.getElementById("cancel-button").addEventListener('click', function() {
      iframeControl('start');
      hideElement('#transaction-details-area');
      showElement('#homepage-heading');
      window.clearProductSelection(); // Clear selection and recalculate total (which will be 0)
      window.hideElement('#transaction-screen'); // Hide the transaction display
      window.latestUserID = '0';
      window.editingMode = false; // Ensure not in editing mode when going back to homepage/scanner
      window.updateTransactionAreaButtons(); // Reset buttons to default mode
    });

    document.getElementById("clear-selection-button").addEventListener('click', window.clearProductSelection);
    document.getElementById("add-product-toggle-button").addEventListener('click', function() {
        window.showAddProductForm(document.getElementById('add-product-form-container').style.display === 'none');
    });
    document.getElementById("submitNewProduct").addEventListener('click', window.addNewProduct);
    document.getElementById("cancelAddProduct").addEventListener('click', function() {
        window.showAddProductForm(false);
    });
    // NEW: Add listener for the toggle edit mode button
    document.getElementById("toggleEditModeButton").addEventListener('click', window.toggleEditingMode);


    window.buyButton = document.getElementById('transaction-option'); 
    window.bidButton = document.getElementById('auction-option'); 

    buyButton.addEventListener("click", function() {
      bidButton.classList.remove('menu-item-selected');
      buyButton.classList.add('menu-item-selected');
      iframeControl('start');
      hideElement('#homepage-heading');
      hideElement('#bidScreen');
      showElement('#transaction-screen'); // Show the transaction display (scanner + product area)
      hideElement('#transaction-details-area'); // Hide product selection initially, until user scans
      window.clearProductSelection(); // Reset quantities
      window.editingMode = false; // Ensure not in editing mode when starting a new sale
      window.fetchAndRenderProducts(); // Fetch and display products in default mode
      window.showAddProductForm(false); // Hide the add product form initially
      window.latestUserID = '0'; // Reset user ID on entry
      window.updateTransactionAreaButtons(); // Ensure buttons are set for default (sale) mode
    });
    bidButton.addEventListener("click", function() {
      console.log('Ask For Help button triggered popup.');
      showPopup("flex", "Help is on the way", "none", "Aim this screen toward shoppers so we can find you faster.");
      window.err(true);
    });

    window.iframeControl = function(status) {
      if (status == "start") {
        document.getElementById('scaniframe').src = 'https://peemima.github.io/lux-bank/scanner/';
        document.getElementById('scaniframe').style.display = 'block';
      } else if (status == "stop") {
        document.getElementById('scaniframe').style.display = 'none';
        document.getElementById('scaniframe').src = 'about:blank';
      }
    }

    window.latestUserID = '0'; 

    window.addEventListener('message', (event) => {
      if (event.origin === 'https://peemima.github.io' && event.data) {
        setTimeout(function(){
          const scannedID = event.data;
          window.latestUserID = scannedID;

          hideElement('#scaniframe');
          showElement('#transaction-details-area');
          
          if (window.latestUserID === '0' || isNaN(window.latestUserID)) {
              showPopup("flex", "Scan Error", "block", "Failed to scan user ID. Please try again.");
              iframeControl('start');
          } else {
              // User ID successfully scanned. No specific popup here to avoid interrupting workflow.
              // The next step is to select products, which is visually clear.
          }
        }, 1000);
      }
    });
    
    // Setup scripting (initial hide/show)
      hideElement('#transaction-screen');
      hideElement('#bidScreen');
      hideElement('#transaction-details-area');
      hideElement('#add-product-form-container');
  </script>
  <style>
    /* Basic styling for product grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 8px;
      margin-top: 20px;
    }

    .product-card {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-card h3 {
      margin-top: 0;
      margin-bottom: 5px;
      font-size: 1.1em;
      color: #333;
    }

    /* Adjusted .product-card p to use flex and align content correctly */
    .product-card p {
      margin-bottom: 10px;
      display: flex; /* Use flexbox for layout inside p */
      align-items: center; /* Vertically align items */
      justify-content: center; /* Center horizontally */
      font-size: 0.9em; /* Default font size for price display */
      color: #666; /* Default color for price display */
    }

    /* New style for the price label in editing mode */
    .product-card .price-label {
        color: #666; /* Color for the label text */
        font-size: 0.9em; /* Font size for the label text */
        white-space: nowrap; /* Prevent "Price: $" from wrapping */
        margin-right: 5px; /* Spacing between label and input */
    }

    /* REMOVED: .product-card p::before pseudo-element rules */


    .quantity-control {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
    }

    .quantity-control button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2em;
      margin: 0 5px;
      min-width: 30px;
      user-select: none;
    }

    .quantity-control button:hover {
      background-color: #0056b3;
    }
    .quantity-control button:active {
        background-color: #004085;
    }

    .product-quantity {
      font-size: 1.2em;
      font-weight: bold;
      min-width: 25px;
      display: inline-block;
      text-align: center;
    }

    .delete-product-button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
    }
    .delete-product-button:hover {
        background-color: #c82333;
    }
    .delete-product-button:active {
        background-color: #bd2130;
    }

    .product-summary {
      text-align: right;
      margin-top: 20px;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }

    .product-summary p {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .product-summary #totalSaleAmount {
        color: #007bff;
    }

    #add-product-form-container {
      background-color: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #add-product-form-container h3 {
        margin-top: 0;
        color: #333;
    }
    
    #add-product-form-container input[type="text"],
    #add-product-form-container input[type="number"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #add-product-form-container button {
        margin-right: 10px;
    }
    #add-product-toggle-button {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      font-size: 1em;
    }
    /* Specific styling for the action buttons at the bottom of the form */
    #transaction-screen .action-buttons-container {
        text-align: center; 
        margin-top: 20px;
    }
    #transaction-screen .action-buttons-container button.fill-button,
    #transaction-screen .action-buttons-container button.outline-button {
        width: auto;
        min-width: 100px;
        margin: 0 5px;
        padding: 10px 20px;
        font-size: 1em;
    }

    /* Style for the transaction-details-area itself */
    #transaction-details-area {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    #transaction-details-area h2 {
        text-align: center;
        color: #333;
        margin-top: 0;
        margin-bottom: 20px;
    }

    /* New styles for editing mode inputs */
    .product-card .edit-input-name {
        width: calc(100% - 10px);
        padding: 5px;
        margin-bottom: 5px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .product-card .edit-input-price {
        padding: 5px;
        margin-bottom: 5px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        box-sizing: border-box;
        flex-grow: 1;
    }
    
    /* The .price-edit-group will use the existing .product-card p flex styling */
  </style>
</head>
<body>
  <div id="main-content"> 
    <div id="businessInfo" style="display: grid; grid-template-columns: 1fr auto 1fr;">
      <span id="businessName" style="float: left;">...</span>
      <img class="logo" src="https://peemima.github.io/lux-bank/assets/fireyhills.png">
      <span id="businessBalance" style="float: right; text-align: right;">...</span>
    </div>
    <div id="homepage">
      <h2 id="homepage-heading">Welcome to your business dashboard</h2>
      <div class="menu-container">
        <p id="transaction-option" class="menu-item">New Sale</p>
        <p id="auction-option" class="menu-item">Get Support</p>
      </div>
    </div>
    
    <div id="transaction-screen" class="center">
      <iframe id="scaniframe" style="border: 0px;" width="100%" height="500px" src="about:blank"></iframe>
      <div id="transaction-details-area">
        <!-- NEW: Toggle Edit Mode Button -->
        <button type="button" id="toggleEditModeButton" class="fill-button" style="margin-bottom: 15px; width: 100%;">Edit Products</button>
        
        <h2>Select Products</h2>
        <div id="products-grid" class="product-grid">
          <!-- Products will be rendered here by JavaScript -->
        </div>
        
        <!-- NEW: product-summary will be hidden/shown by JS -->
        <div id="product-summary" class="product-summary">
          <p>Total: <span id="totalSaleAmount">$0.00</span></p>
          <button type="button" id="clear-selection-button" class="outline-button">Clear Selection</button>
        </div>
        
        <!-- NEW: add-product-toggle-button will be hidden/shown by JS -->
        <button type="button" id="add-product-toggle-button" class="fill-button">Add/Hide New Product Form</button>
        
        <div id="add-product-form-container" style="display: none;">
          <h3>Add New Product</h3>
          <!-- This is now a completely separate form -->
          <form id="addNewProductForm" onsubmit="return false;"> 
            <input type="text" id="newProductName" name="newProductName" placeholder="Product Name" required>
            <input type="number" id="newProductPrice" name="newProductPrice" placeholder="Price (Hawkeyes)" step="1" min="1" required>
            <button type="button" id="submitNewProduct" class="fill-button">Create Product</button>
            <button type="button" id="cancelAddProduct" class="outline-button">Cancel</button>
          </form>
        </div>
        
        <div class="action-buttons-container">
          <button type="button" id="cancel-button" class="outline-button">Back</button>
          <button type="button" class="fill-button" id="processSaleButton">Process Sale</button> 
          <!-- NEW: Save All Changes and Cancel Edits buttons will be dynamically added/shown/hidden here by JS -->
        </div>
      </div>
    </div>

    <div id="bidScreen">
      Bid screen content
    </div>
  </div>
  <div id="login-screen" class="center-container" style="display: none;">
    <h1 style="font-family: 'Poppins', sans-serif; font-weight: 500">Login to your business</h1>
    <form onSubmit="return false;">
      <input autocomplete="off" id="businessNameInput" type="text" placeholder="">
    </form>
    <div id="suggestions"></div>
  </div>
</body>
</html>
