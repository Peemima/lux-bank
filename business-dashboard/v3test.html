<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Day Business Dashboard</title>
  <script src="https://peemima.github.io/lux-bank/assets/popup-code.js"></script>
  <noscript>
    <h1>js_err_noscrpt_popup</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Tell Ian F about it immediately.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
  <link rel="stylesheet" href="/lux-bank/assets/styles.css">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js" defer></script>
  <style>
    #barcode-reader {
      width: 100%;
      max-width: 500px;
    }

    #reader-contaier {
      position: relative;
      width: 100%;
      overflow: hidden;
      border-radius: 40px;
    }

    #reader {
      position: relative;
      -webkit-transform: scaleX(-1);
      transform: scaleX(-1);
    }

    #scanOverlay {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 2;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      vertical-align: center;
      justify-content: center;
    }

    @keyframes blurInOut {
      0% {
        backdrop-filter: blur(10px);
      }

      50% {
        backdrop-filter: blur(5px);
      }

      100% {
        backdrop-filter: blur(10px);
      }
    }

    #result {
      margin-top: 10px;
      font-size: 18px;
    }

    scan-area {
      box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
    }

    #scanningVideo {
      width: 175px;
      max-width: 30%;
      border-radius: 23%;
      margin: 0px;
    }
    
    .barcode-container {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      text-align: center;
      font-size: 19px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
        authDomain: "lux-bank.firebaseapp.com",
        databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
        projectId: "lux-bank",
        storageBucket: "lux-bank.appspot.com",
        messagingSenderId: "764922032293",
        appId: "1:764922032293:web:573599b6116f025ee15d4c",
        measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    console.log("%cVersion: %c1.634", "color: black; font-size:75px;", "color: red; font-size:75px;");

    // Make hideElement a window function
    window.hideElement = function(identifier) {
      document.querySelectorAll(identifier).forEach(item => { item.style.display = 'none'; });
    };

    // Make showElement a window function
    window.showElement = function(identifier) {
      document.querySelectorAll(identifier).forEach(item => { item.attributeStyleMap.delete('display') });
    };

    window.businessValue = new URLSearchParams(window.location.search).get('businessvalue');

    if (businessValue) {
      document.getElementById("businessName").innerText = businessValue;

      function ensureBusinessAccountExists() {
        if (businessValue != null) {
          const businessRef = ref(database, `businesses/${businessValue}`);
          get(businessRef).then((snapshot) => {
            if (!snapshot.exists()) {
              window.location.href = `?businessvalue=`;
            }
          }).catch((error) => {
            console.error('Error checking for business existence:', error);
          });
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        ensureBusinessAccountExists();
        fetchAndDisplayBusinessBalance();
      });

      document.getElementById("transactionForm").addEventListener("submit", function(event) {
        event.preventDefault(); 

        const amount = parseFloat(document.getElementById("amountInput").value);

        if (isNaN(amount) || amount <= 0) {
          showPopup("flex", "Notice", "block", "Please enter a valid price for this product");
          return;
        }

        processTransaction(amount);
      });

      let userCard  = document.getElementsByClassName("user-card");

      function processTransaction(amount) {
        get(ref(database, 'users')).then((snapshot) => {
          if (snapshot.exists()) {
            const users = snapshot.val();
            const userID = window.latestScan; // Use the latest scanned QR code

            for (let userKey in users) {
              if (users[userKey].id === userID) {
                const userName = userKey.split(' ')[0]; 

                let currentBalance = users[userKey].balance;
                if (amount > currentBalance) {
                  showPopup("flex", "Not enough hawkeyes", "block", `It looks like there aren't enough hawkeyes to buy that.`);
                  return;
                }

                let newBalance = currentBalance - amount; 
                set(ref(database, 'users/' + userKey + '/balance'), newBalance)
                  .then(() => {
                    updateBusinessBalance(amount);
                    logTransaction(userKey, userID, -amount, newBalance, businessValue, businessData.balance); 
                    document.getElementById("transactionForm").reset();
                    document.getElementById("user-card").style.display = "block";
                    document.getElementById("transaction-amount").style.display = "none";
                    showElement('#homepage-heading');
                    showPopup("flex", "Success!", "block", `The transaction was successful!`);
                    hideElement('#transactionForm');
                  })
                  .catch((error) => {
                    console.error('Error updating user balance:', error);
                    showPopup("flex", "Help is on the way", "none", "There was an error, but don't worry, help is on the way.");
                  });
                return; 
              }
            }
            showPopup("flex", "Notice", "block", "That doesn't seem to be a valid user id.");
          } else {
            console.log('No users found in the database.');
          }
        }).catch((error) => {
          console.error('Error fetching user data:', error);
          showPopup("flex", "Help is on the way", "none", "There was an error, but don't worry, help is on the way.");
        });
      }

      function logTransaction(userKey, userId, amount, newBalance, businessValue, businessBalanceAmount) {
        const transactionID = `trans_${Date.now()}_${Math.floor(Math.random() * 1000)}`; 
        const transactionRef = ref(database, 'transactions/' + transactionID); 
        const transactionData = {
          userKey: userKey,
          userId: userId,
          amount: amount,
          newBalance: newBalance,
          businessBalance: businessBalanceAmount,
          business: businessValue, 
          timestamp: Date.now() 
        };

        set(transactionRef, transactionData)
          .then(() => {
            console.log('Transaction logged successfully.');
          })
          .catch((error) => {
            console.error('Error logging transaction:', error);
          });
      }

      function updateBusinessBalance(amountToAdd) {
        const businessRef = ref(database, `businesses/${businessValue}/balance`);
        get(businessRef).then((snapshot) => {
          let newBalance;
          let currentBalance = snapshot.exists() ? snapshot.val() : 0; 
          newBalance = currentBalance + amountToAdd;
          set(businessRef, newBalance).then(() => {
            console.log("Business balance updated successfully.");
          }).catch((error) => {
            console.error("Error updating business balance:", error);
          });
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
        });
      }

      function fetchAndDisplayBusinessBalance() {
        const businessRef = ref(database, `businesses/${businessValue}/balance`);
        get(businessRef).then((snapshot) => {
          if (snapshot.exists()) {
            document.getElementById("businessBalance").innerText = `$${snapshot.val().toFixed(2)}`;
          } else {
            document.getElementById("businessBalance").innerText = "$0.00";
          }
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
        });
      }
    } else {
      window.location.href = "?businessvalue=";
    }
  </script>
</head>
<body>
  <div id="barcode-reader">
    <h2 style="font-family: Poppins, sans serif;">How to scan</h2>
    <p style="font-family: Poppins, sans serif;">Scan the ID of the customer.</p>
    <div id="reader-contaier">
      <div id="scanOverlay">
        <video id="scanningVideo" loop muted="true" src="https://peemima.github.io/lux-bank/assets/scanbarcode.mp4"></video>
      </div>
      <div id="reader">Scanned users are as follows: </div>
    </div>
    <div id="result"></div>
    <button style="display: none;" id="finish-scanning">Next</button>
  </div>

  <div id="form-container" style="display: none;">
    <h1 id="businessName">Business Name</h1>
    <p>Your current balance: <span id="businessBalance">$0.00</span></p>
    <form id="transactionForm">
      <label for="amountInput">Amount:</label>
      <input type="number" id="amountInput" name="amount" required>
      <button type="submit">Submit</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
</body>
</html>
