<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lux Banking Dashboard</title>
  <noscript>
    <h1>js_err_noscrpt_popup</h1>
    <p>A wild error popped out of nowhere!</p>
    <p>Tell Ian F about it immediately.</p>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
  </noscript>
<link rel="stylesheet" href="/lux-bank/assets/styles.css">

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASd5JOikXTlRp8eA2j_26Z1NWatZMjZds",
        authDomain: "lux-bank.firebaseapp.com",
        databaseURL: "https://lux-bank-default-rtdb.firebaseio.com",
        projectId: "lux-bank",
        storageBucket: "lux-bank.appspot.com",
        messagingSenderId: "764922032293",
        appId: "1:764922032293:web:573599b6116f025ee15d4c",
        measurementId: "G-JQ7CWEJS9N"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.businessValue = new URLSearchParams(window.location.search).get('businessvalue');
    
    if (businessValue) {
      // Business value is present in the URL, show the dashboard
      document.getElementById("businessName").innerText = businessValue;

      let currentSearchQuery = "";

      // Function to check if business account exists and redirect if not
      function ensureBusinessAccountExists() {
        if (businessValue != null) {
          const businessRef = ref(database, `businesses/${businessValue}`);
          get(businessRef).then((snapshot) => {
            if (!snapshot.exists()) {
              window.location.href = `?businessvalue=`;
            }
          }).catch((error) => {
            console.error('Error checking for business existence:', error);
          });
        }
      }

      // Call the function to ensure business account exists on load
      document.addEventListener("DOMContentLoaded", function() {
        ensureBusinessAccountExists();
      });

      document.addEventListener("DOMContentLoaded", function() {
        const searchForm = document.getElementById("searchForm");
        searchForm.addEventListener("submit", function(event) {
          event.preventDefault();
          currentSearchQuery = document.getElementById("searchInput").value.trim(); // Get the raw input
          fetchAndDisplayUsers(currentSearchQuery); 
        });

        // Fetch and display users right away
        fetchAndDisplayUsers();
      });

      function fetchAndDisplayUsers(query = "") {
        get(ref(database, 'users')).then((snapshot) => {
          if (snapshot.exists() && Object.keys(snapshot.val()).length > 0) {
            const users = snapshot.val();
            // Filter users based on ID match
            let matchingUsers = Object.entries(users).filter(([userName, userData]) => {
              return userData.id && userData.id.toString().includes(query);
            });

            let content = "";
            if (matchingUsers.length === 0) { 
              document.getElementById("allUsers").innerHTML = `<div class="user-info"><p class="list-name">No matching users found.</p></div>`;
            } else {
              matchingUsers.forEach(([userName, userData], index) => {
                let positionClass = 'user-middle';
                if (matchingUsers.length === 1) {
                  positionClass = 'only-user';
                } else if (index === 0) {
                  positionClass = 'user-top';
                } else if (index === matchingUsers.length - 1) {
                  positionClass = 'user-bottom';
                }
                content += `<div class="${positionClass}"><p class="list-name">${userName}: $${userData.balance} (ID: ${userData.id})</p><button class="fill-button" onclick="openModal('${userData.id}')">Select</button></div>`;
              });
              document.getElementById("allUsers").innerHTML = content;
            }
          } else {
            document.getElementById("allUsers").innerHTML = `<div class="user-info"><p class="list-name">No users found.</p></div>`;
          }
        }).catch((error) => {
          console.error("Error fetching users: ", error);
          document.getElementById("allUsers").innerText = 'Err_fetching_users: A wild error apeared! Contact Ian F *immediately*';
        });
      }

      let selectedUserID = ''; 

      window.openModal = function(userID) {
        selectedUserID = userID; 
        document.getElementById('userModal').style.display = 'block'; 
        document.getElementById('modal-header').innerText = `Edit User (ID: ${selectedUserID})`;
      };

      document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('userModal').style.display = 'none';
      }); 

      window.addAmount = function() {
        const amount = Number(document.getElementById('amountInput').value);
        updateUserBalance(selectedUserID, amount); 
      };

      document.getElementById('amountInput').addEventListener('input', function(e) {
        const validValue = this.value.replace(/[^0-9]/g, '');
        if (this.value !== validValue) {
          this.value = validValue;
          this.classList.add('jiggle');
          setTimeout(() => {
            this.classList.remove('jiggle');
          }, 500);
        }
      });

      function updateUserBalance(userID, amount) {
        // Find the user by ID
        get(ref(database, 'users')).then((snapshot) => {
          if (snapshot.exists()) {
            const users = snapshot.val();
            for (let userKey in users) {
              if (users[userKey].id === userID) {
                let currentBalance = users[userKey].balance;
                let newBalance = currentBalance + amount; 

                set(ref(database, 'users/' + userKey + '/balance'), newBalance)
                  .then(() => {
                    console.log('User balance updated successfully.');
                    if (amount < 0) {
                      updateBusinessBalance(Math.abs(amount));
                    }
                    logTransaction(userKey, amount, newBalance, businessValue, businessData.balance); 
                    document.getElementById('userModal').style.display = 'none';
                    fetchAndDisplayUsers(currentSearchQuery); // Refresh the user list
                  })
                  .catch((error) => {
                    console.error('Error updating user balance:', error);
                  });
                return; // Stop searching after finding the user
              }
            }
            console.log('No user found with ID:', userID);
          } else {
            console.log('No users found in the database.');
          }
        }).catch((error) => {
          console.error('Error fetching user data:', error);
        });
      }

      function logTransaction(userKey, amount, newBalance, businessValue, businessBalanceAmount) {
        const transactionID = `trans_${Date.now()}_${Math.floor(Math.random() * 1000)}`; 
        const transactionRef = ref(database, 'transactions/' + transactionID); 
        const transactionData = {
          userKey: userKey,
          amount: amount,
          newBalance: newBalance,
          businessBalance: businessBalanceAmount,
          business: businessValue, 
          timestamp: Date.now() 
        };

        set(transactionRef, transactionData)
          .then(() => {
            console.log('Transaction logged successfully.');
          })
          .catch((error) => {
            console.error('Error logging transaction:', error);
          });
      }

      function updateBusinessBalance(amountToAdd) {
        const businessRef = ref(database, `businesses/${businessValue}/balance`);

        get(businessRef).then((snapshot) => {
          let newBalance;
          let currentBalance = snapshot.exists() ? snapshot.val() : 0; 
          newBalance = currentBalance + amountToAdd;
          set(businessRef, newBalance).then(() => {
            console.log(`Business balance updated to ${newBalance}`);
            fetchAndDisplayBusinessBalance(); // Update the displayed balance
          }).catch((error) => {
            console.error('Error updating business balance:', error);
          });
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
          set(businessRef, amountToAdd).then(() => {
            console.log('Business balance initialized and set to:', amountToAdd);
          }).catch((initError) => {
            console.error('Error initializing business balance:', initError);
          });
        });
      }

      window.withdrawAmount = function() {
        const amountInput = document.getElementById('amountInput');
        const amountToWithdraw = Number(amountInput.value);
        const userID = selectedUserID; 

        // Find the user by ID
        get(ref(database, 'users')).then((snapshot) => {
          if (snapshot.exists()) {
            const users = snapshot.val();
            for (let userKey in users) {
              if (users[userKey].id === userID) {
                let currentBalance = users[userKey].balance;
                if (amountToWithdraw > currentBalance) {
                  amountInput.classList.add('jiggle');
                  setTimeout(() => {
                    amountInput.classList.remove('jiggle');
                  }, 500);
                } else {
                  let newBalance = currentBalance - amountToWithdraw; 

                  // Update the user's balance
                  set(ref(database, 'users/' + userKey + '/balance'), newBalance)
                    .then(() => {
                      console.log('Withdrawal successful, user balance updated.');
                      updateBusinessBalance(amountToWithdraw);
                      logTransaction(userKey, -amountToWithdraw, newBalance, businessValue, businessData.balance);
                      document.getElementById('userModal').style.display = 'none';
                      fetchAndDisplayUsers(currentSearchQuery); // Refresh the user list
                    })
                    .catch((error) => {
                      console.error('Error updating user balance:', error);
                    });
                }
                return; // Stop searching after updating the user
              }
            }
            console.log('No user found with ID:', userID); 
          } else {
            console.log('No users found in the database.');
          }
        }).catch((error) => {
          console.error('Error fetching user data:', error);
        });
      };


      function fetchAndDisplayBusinessBalance() {
        const businessRef = ref(database, `businesses/${businessValue}`);
        get(businessRef).then((snapshot) => {
          if (snapshot.exists()) {
            window.businessData = snapshot.val();
            document.getElementById('businessBalance').innerText = `Balance: $${businessData.balance}`;
          } else {
            console.error('Business data not found');
          }
        }).catch((error) => {
          console.error('Error fetching business balance:', error);
        });
      }

      setInterval(fetchAndDisplayBusinessBalance, 200);
      setInterval(() => {
        fetchAndDisplayUsers(currentSearchQuery); 
      }, 750); 

      fetchAndDisplayBusinessBalance();
    } else {
      // Business value is not present in the URL, show the login screen
      document.getElementById("main-content").style.display = 'none'; 
      document.getElementById("login-screen").style.display = 'block'; 

      let businessSuggestions = [];

      document.getElementById("businessNameInput").addEventListener("mousedown", function() {
        document.getElementById("businessNameInput").placeholder = "Business Name";
      });

      document.getElementById("businessNameInput").addEventListener("blur", function() {
        document.getElementById("businessNameInput").placeholder = "";
      });

      document.getElementById("businessNameInput").addEventListener("input", function() {
        const inputValue = this.value.trim().toLowerCase();
        get(ref(database, 'businesses')).then(snapshot => {
          if (snapshot.exists()) {
            const businesses = snapshot.val();
            businessSuggestions = Object.keys(businesses).filter(business => 
              business.toLowerCase().includes(inputValue)
            );
            updateSuggestions(businessSuggestions); 
          } else {
            console.error('No businesses found in the database.');
          }
        }).catch(error => {
          console.error('Error fetching businesses:', error);
        });
      });

      function updateSuggestions(suggestions) {
        const suggestionList = document.getElementById('suggestions');
        if (suggestions.length > 0) {
          suggestionList.style.display = 'block'; 
          suggestionList.innerHTML = ''; 
          suggestions.forEach(suggestion => {
            const suggestionItem = document.createElement('div');
            suggestionItem.classList.add('suggestion-item');
            suggestionItem.textContent = suggestion;
            suggestionItem.addEventListener('click', () => {
              window.location.href = `?businessvalue=${suggestion}`;
            });
            suggestionList.appendChild(suggestionItem);
          });
        } else {
          suggestionList.innerHTML = '<div class="suggestion-item">No businesses found</div>';
          suggestionList.style.display = 'block'; 
        }
      }
      };
  </script>
</head>
<body>

  <div id="main-content"> 
    <div id="businessInfo" style="display: grid; grid-template-columns: 1fr auto 1fr;">
      <span id="businessName" style="float: left;">...</span>
      <img class="logo" src="/lux-bank/assets/Lux_Logo.svg">
      <span id="businessBalance" style="float: right; text-align: right;">...</span>
    </div>

    <form id="searchForm">
      <input type="text" id="searchInput" placeholder="Enter User ID...">
      <button class="fill-button" type="submit">Search</button>
      <button id="resetButton" style="display: none;" class="outline-button">Reset</button>
    </form>
    <div id="allUsers" class="container"></div>

    <div id="userModal" class="modal">
      <div class="modal-content">
        <span class="close">×</span>
        <h2 id="modal-header">Edit User Balance</h2>
        <p>Transactions are measured in Lux.</p>
        <input type="text" id="amountInput" placeholder="Enter amount..." pattern="\d*">
        <button class="fill-button" onclick="addAmount()">Add</button>
        <button class="outline-button" onclick="withdrawAmount()">Withdraw</button>
      </div>
    </div>
  </div>

  <div id="login-screen" class="center-container" style="display: none;"
    >
    <h1 style="font-family: 'Poppins', sans-serif; font-weight: 500">Login to your business</h1>
    <form onSubmit="return false;">
      <input id="businessNameInput" type="text" placeholder="">
    </form>
    <div id="suggestions"></div>
  </div>

</body>
</html>
